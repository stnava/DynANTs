---
title: "ANTs longitudinal cortical thickness statistics"
output: pdf_document
---

# Objective
Compare results of your local ANTs processing to a set of reference results

```{r fig.width=8, fig.height=4, echo=FALSE}
library(ANTsR)
library(ggplot2)
library(date)
library(lme4)
library(nlme)
library(lmerTest)
library(packHV)
library(lattice)
verbose<-FALSE
##############################
##############################
```

Define study demographic parameters.  
We use the demographics file to construct
the expected image file prefix.
```{r fig.width=8, fig.height=4, echo=TRUE,warnings=FALSE,message=FALSE,error=FALSE}
### Most important thing - load a csv
### location of subject directories
basedir<-"/Users/stnava/Downloads/LongitudinalX/antslongct/"
demog<-read.csv(paste(basedir,'../FTD_Long_Nov_2014.csv',sep='/'))
expectedImagePrefix<-rep("NA",nrow(demog))
haveSubjectTimePoint<-rep(FALSE,nrow(demog))
for ( i in 1:nrow(demog) )
  {
  myid<-demog$INDDID[i]
  rawdate<-as.character(demog$MRIDate[i])
  rawdatesplit<-unlist(strsplit(rawdate,'/'))
  locyear<-rawdatesplit[3]
  locmon<-rawdatesplit[1]
  locday<-rawdatesplit[2]
  expectedImagePrefix[i]<-paste(myid,'_',locyear,locmon,locday,sep='')
  findfn<-Sys.glob(paste(basedir,'/',myid,
    '/',expectedImagePrefix[i],"*",sep=''))
  if ( length(findfn) > 0) haveSubjectTimePoint[i]<-TRUE
  }
if ( verbose ) print(sum(haveSubjectTimePoint))
demog<-cbind(demog,expectedImagePrefix=expectedImagePrefix,
  haveSubjectTimePoint=haveSubjectTimePoint)
```

Define study imaging parameters
```{r fig.width=8, fig.height=4, echo=TRUE,warnings=FALSE,message=FALSE}
studytype<-c('jacobian','thickness')[2]
outprefix<-paste('/Users/stnava/Downloads/LongitudinalX/temp/FTD_Stats_',studytype,sep='')
# get all of these paths / filenames right ....
maskfn<-"/Users/stnava/Downloads/LongitudinalX/pennTemplate/masks/templateBrainMaskProbability.nii.gz"
testmaskfn<-"/Users/stnava/Downloads/LongitudinalX/pennTemplate/labels/antsMalfLabels.nii.gz"
if ( ! file.exists(maskfn) ) if ( verbose ) print(paste(maskfn,'doesnt exist'))
if ( ! file.exists(testmaskfn) ) if ( verbose ) print(paste(testmaskfn,'doesnt exist'))
temimg<-antsImageRead(maskfn,3)
smoothingparam<-2.0 # smoothing before stats
```

Now do the preprocessing

Get the csv summary files.
```{r fig.width=8, fig.height=4, echo=TRUE,warnings=FALSE,message=FALSE}
csvs<-c()
csvs<-rep(NA,nrow(demog))
ncolslist<-rep(NA,nrow(demog))
ct<-1
for ( x in demog$expectedImagePrefix  )
  {
  temp<-Sys.glob(paste(basedir,"*/*/",x,"*MPR*brainvols.csv",sep=''))
  if ( length(temp) > 0 )
    {
    csvs[ct]<-temp
    tempcsv<-read.csv(temp)
    ncolslist[ct]<-ncol(tempcsv)
    }
  if ( length(temp) > 1 ) stop(paste("multi-match error",x))
  ct<-ct+1
  }
if ( sd( ncolslist[ !is.na(ncolslist) ] ) > 0 )
  stop("different n columns in some files")
csvdf<-matrix( rep(NA, ncolslist[ !is.na(ncolslist) ][1]*nrow(demog) ),
  nrow=nrow(demog) )
colnames(csvdf)<-colnames(tempcsv)
myimagingdf <-data.frame( demog,csvdf  )
ct<-1
for ( x in demog$expectedImagePrefix  )
  {
  temp<-Sys.glob(paste(basedir,"*/*/",x,"*MPR*brainvols.csv",sep=''))
  if ( length(temp) > 0 )
    {
    csvs[ct]<-temp
    tempcsv<-read.csv(temp)
    myimagingdf[ct,2:ncol(myimagingdf)]<-tempcsv
    ncolslist[ct]<-ncol(tempcsv)
    }
  ct<-ct+1
  }
```

```{r derka, fig.width=8, fig.height=4, echo=TRUE,warnings=FALSE,message=FALSE}
mydelt<-rep(NA,nrow(demog))
ct<-2 # start here b/c we check one back
while ( ct <= nrow(myimagingdf ) )
  {
  if ( demog$INDDID[ct] == demog$INDDID[ct-1] &
       ! is.na(demog$INDDID[ct]) )
    {
    basect<-which( demog$INDDID == demog$INDDID[ct] )[1]
    allct<-which( demog$INDDID == demog$INDDID[ct] )
    demog$AgeatMRI[ allct ]<-demog$AgeatMRI[basect]
    mydelt[basect]<-0
    dt1<-as.character( demog$MRIDate[ct] )
    dt2<-as.character( demog$MRIDate[basect] )
    mydelt[ct]<-as.date(dt1,order='mdy')-
                as.date(dt2,order='mdy')
    }
  ct<-ct+1
  }
```

```{r derka2, fig.width=8, fig.height=4, echo=TRUE,warnings=FALSE,message=FALSE}
myimagingdf<-cbind(myimagingdf,INDDID=demog$INDDID,timeSinceBaseline=mydelt)
```


```{r fig.width=8, fig.height=4, echo=TRUE,warnings=FALSE,message=FALSE}
p<-ggplot(data=myimagingdf , aes( x = timeSinceBaseline, y = BVOL,
  group = INDDID )) +   geom_line()  + geom_point()
plot(p)
```

```{r firstplot, fig.width=8, fig.height=4, echo=TRUE,warnings=FALSE,message=FALSE}
for ( jj in 16:19 )
  {
  imging<-myimagingdf[,jj]
  myform<-as.formula( paste("imging~timeSinceBaseline+(1|INDDID)" ) )
  mxf<-lmer(myform,data=myimagingdf)
  smxf<-summary(mxf)
  if ( verbose ) print(smxf)
  locallabel<-colnames(myimagingdf)[jj]
  if ( verbose ) print(paste(locallabel))
  p<-ggplot(data=myimagingdf , aes( x = timeSinceBaseline,
    y = imging, group = INDDID )) +
    geom_line()  + geom_point() + ggtitle(locallabel)
  plot(p)
}
````


```{r derka4, fig.width=8, fig.height=4, echo=TRUE,warnings=FALSE,message=FALSE}
bigct<-1
countup<-0
haveimg<-rep(0,nrow(demog))
for ( loopid in demog$expectedImagePrefix )
  {
  locid<-as.character( loopid )
  if (  myimagingdf$haveSubjectTimePoint[bigct] > 0 &
      ! is.na( loopid ) )
    {
    myid<-as.character(myimagingdf$INDDID[bigct])
    if ( studytype =='thickness')
      { # FIXME - should be more robust
      ipttrn<-glob2rx(paste("*",locid,"*Thickness.nii.gz",sep=''))
      warpfn<-Sys.glob(paste(basedir,"*/*/*",locid,
        "*SubjectToGroupTemplateWarp.nii.gz",sep=''))
      }
    if ( studytype =='jacobian')
      { # FIXME - should be more robust
      ipttrn<-glob2rx(paste("*",locid,"*ToTemplateLogJacobian.nii.gz",sep=''))
  afffn<-Sys.glob(paste(basedir,myid,'/',myid,"*SingleSubjectTemplate/T_templateSubjectToTemplate0GenericAffine.mat",sep='')) # FIXME - should be like imagelistfn
  warpfn<-Sys.glob(paste(basedir,myid,'/',"*SingleSubjectTemplate/T_templateSubjectToTemplate1Warp.nii.gz",sep=''))# FIXME - should be like imagelistfn
      }
      imagelistfn<- paste(basedir,list.files(path=basedir,
        pattern = ipttrn ,recursive=T),sep='/')
      if ( file.exists(warpfn[1]) & file.exists(imagelistfn[1]) )
      {
      ct<-1
      imagelist<-list()
      for ( jfn in imagelistfn ) {
        if ( studytype == 'jacobian' ) txlist<-c( warpfn, afffn )
        if ( studytype != 'jacobian' ) txlist<-c( warpfn[ct] )
        wout<-paste(outprefix,locid,'warped.nii.gz',sep='' )
        if ( verbose ) print(wout)
        countup<-countup+1
        haveimg[bigct]<-1
        if ( ! file.exists(wout) )
          {
          jimg<-antsImageRead( jfn, 3)
          wimg<-antsApplyTransforms( fixed=temimg,
            moving=jimg, transformlist=txlist)
          SmoothImage(3,wimg,smoothingparam,wimg)
          antsImageWrite( wimg , wout )
          } else {
          if ( verbose ) print(paste(locid,wout,'done'))
    #      wimg<-antsImageRead( wout, 3 )
          }
        ct<-ct+1
      }
    }
    }
  bigct<-bigct+1
  }
#
#if ( exists("brain") )
#      plotANTsImage( brain, functional=list(corrs,ncorrs),
#        threshold="0.8x1",slices="40x190x5",color=c("red","blue"),
#        outname=ofn, alpha=0.25)
#
```

Run the voxel-wise stats.

```{r fig.width=8, fig.height=4, echo=TRUE,warnings=FALSE,message=FALSE}
if (  FALSE )
{
wimgfns<-Sys.glob(paste(outprefix,"*warped*.nii.gz",sep=''))
lab<-171
tmask<-antsImageRead(testmaskfn,3)
bmask<-antsImageClone( tmask )
bmask[ bmask > 0 ]<-1
tmask[ tmask != as.numeric(lab) ]<-0
tmask[ tmask == as.numeric(lab) ]<-1
sum(tmask==1)
imglist<-imageFileNames2ImageList( wimgfns, 3 )
imging<-imageListToMatrix( imglist, tmask )
# should be a random effect but it's too slow
subdf<-demog[haveimg==1,]
fid<-as.factor( subdf$INDDID )
tsb<-myimagingdf$timeSinceBaseline[haveimg==1]
quadmodel<-I(tsb)^2
quadmodel<-stats::poly( tsb, 1 )
age<-demog$AgeatMRI[haveimg==1]
mdl<-lm( imging ~ 1 + quadmodel + age + fid )
mdlinterp<-bigLMStats( mdl , 1.e-4 )
print( min(p.adjust(mdlinterp$beta.pval[1,],method='BH'),na.rm=T) )
##### now do a lmer on the whole mat
mdl<-lmer(rowSums(imging)~1+quadmodel*ClinicalPhenotype1
  +(1|fid),data=subdf)
print(summary(mdl))
if ( FALSE ) # do voxelwise study
  {
  for ( i in 1:ncol(imging))
    {
    myform<-as.formula( paste("imging[,",as.character(i)
     ,"]~1+quadmodel+(1|myids)" ) )
    mdl<-lmer(myform,data=filtdf)
    if ( verbose ) print(summary(mdl))
    }
  }
# get rid of random effects
# myform<-as.formula( paste("imging~1+(1|myids)" ) )
# rimging<-residuals( lmer(myform,data=filtdf),type = c("response" ))
# derka
# then do standard bigLMStats
# mylm<-lm( rimging ~  )
# bigLMStats
if ( FALSE )
  {
  ttg<-rep(0,ncol(corrmat))
  ttl<-rep(0,ncol(corrmat))
  for ( i in 1:ncol(corrmat))
    {
    ttg[i]<-t.test(corrmat[,i],alternative = "g")$p.value
    ttl[i]<-t.test(corrmat[,i],alternative = "l")$p.value
    }
  timg<-antsImageClone(tmask)
  timg[tmask==1]<-1.0 - p.adjust( ttg, method='BH' )
  antsImageWrite(timg,'corrtstatG.nii.gz')
  timg<-antsImageClone(tmask)
  timg[tmask==1]<-1.0 - p.adjust( ttl, method='BH' )
  antsImageWrite(timg,'corrtstatL.nii.gz')
  }
}
```


Set up visualization.
